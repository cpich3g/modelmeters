<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chat with Azure AI - Model Meters</title>
    <link rel="icon" type="image/png" href="img/favicon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <style>
        :root {
            --bg: #ffffff;
            --bg-alt: #f7f7f8;
            --text: #374151;
            --text-light: #6b7280;
            --border: #e5e7eb;
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --user-msg-bg: #eff6ff;
            --ai-msg-bg: #ffffff;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        /* 
        Force light theme for Chat UI as per user request to improve readability
        :root[data-theme="dark"] {
            --bg: #111827;
            --bg-alt: #1f2937;
            --text: #f3f4f6;
            --text-light: #9ca3af;
            --border: #374151;
            --primary: #3b82f6;
            --primary-hover: #60a5fa;
            --user-msg-bg: #1e3a8a;
            --ai-msg-bg: #1f2937;
        } 
        */

        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }
        
        /* Header */
        .header { padding: 1rem 1.5rem; background: var(--bg); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .brand { display: flex; align-items: center; gap: 0.75rem; font-weight: 600; font-size: 1.1rem; color: var(--text); text-decoration: none; pointer-events: none; }
        .brand svg { width: 24px; height: 24px; color: var(--primary); }
        
        .controls { display: flex; gap: 1rem; align-items: center; }
        select { padding: 0.5rem; border-radius: 0.5rem; border: 1px solid var(--border); background: var(--bg-alt); color: var(--text); font-size: 0.9rem; outline: none; cursor: pointer; }
        select:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2); }

        /* Chat Area */
        #chat-container { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 1rem; width: 100%; box-sizing: border-box; scroll-behavior: smooth; }
        
        /* Custom Scrollbar */
        #chat-container::-webkit-scrollbar { width: 6px; }
        #chat-container::-webkit-scrollbar-track { background: transparent; }
        #chat-container::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.1); border-radius: 3px; }
        /* :root[data-theme="dark"] #chat-container::-webkit-scrollbar-thumb { background-color: rgba(255,255,255,0.1); } */

        .message { display: flex; gap: 0.75rem; max-width: 100%; animation: fadeIn 0.3s ease; }
        .message.user { flex-direction: row-reverse; }
        
        .avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1.1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .user .avatar { background: var(--primary); color: white; }
        .assistant .avatar { background: #10a37f; color: white; } /* OpenAI Green */

        .bubble { padding: 0.75rem 1rem; border-radius: 1rem; max-width: 85%; line-height: 1.5; position: relative; box-shadow: var(--shadow); overflow-wrap: break-word; font-size: 0.95rem; }
        .user .bubble { background: linear-gradient(135deg, var(--primary), var(--primary-hover)); border-top-right-radius: 0.25rem; color: white; border: none; }
        .assistant .bubble { background: var(--ai-msg-bg); border: 1px solid var(--border); border-top-left-radius: 0.25rem; }

        /* Markdown Styles */
        .bubble h1, .bubble h2, .bubble h3 { margin-top: 0.5rem; margin-bottom: 0.5rem; font-size: 1rem; }
        .bubble p { margin: 0.5rem 0; }
        .bubble p:first-child { margin-top: 0; }
        .bubble p:last-child { margin-bottom: 0; }
        .bubble code { background: rgba(0,0,0,0.1); padding: 0.2rem 0.4rem; border-radius: 4px; font-family: monospace; font-size: 0.9em; }
        .user .bubble code { background: rgba(255,255,255,0.2); }
        .bubble pre { background: #2d2d2d; color: #ccc; padding: 0.75rem; border-radius: 0.5rem; overflow-x: auto; margin: 0.5rem 0; }
        .bubble pre code { background: transparent; padding: 0; color: inherit; }
        .bubble table { border-collapse: collapse; width: 100%; margin: 0.5rem 0; font-size: 0.85rem; }
        .bubble th, .bubble td { border: 1px solid var(--border); padding: 0.4rem; text-align: left; }
        .bubble th { background: var(--bg-alt); font-weight: 600; }
        .user .bubble th, .user .bubble td { border-color: rgba(255,255,255,0.2); }
        .user .bubble th { background: rgba(255,255,255,0.1); }

        /* Input Area */
        .input-area { padding: 1rem; background: var(--bg); border-top: 1px solid var(--border); }
        .input-wrapper { width: 100%; position: relative; display: flex; gap: 0.5rem; align-items: flex-end; background: var(--bg-alt); border: 1px solid var(--border); border-radius: 1.5rem; padding: 0.5rem 0.75rem; transition: all 0.2s; box-sizing: border-box; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); }
        .input-wrapper:focus-within { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1), inset 0 1px 2px rgba(0,0,0,0.05); background: var(--bg); }
        
        textarea { flex: 1; background: transparent; border: none; color: var(--text); font-size: 0.95rem; resize: none; max-height: 150px; padding: 0.5rem 0.25rem; outline: none; font-family: inherit; line-height: 1.4; }
        
        button#send-btn { background: var(--primary); color: white; border: none; border-radius: 50%; width: 36px; height: 36px; padding: 0; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button#send-btn:hover { background: var(--primary-hover); transform: scale(1.05); }
        button#send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        button#send-btn svg { width: 18px; height: 18px; margin-left: 2px; } /* Optical centering */

        .typing-indicator { display: none; font-size: 0.75rem; color: var(--text-light); margin-bottom: 0.5rem; margin-left: 3rem; }
        .typing-indicator.active { display: flex; gap: 4px; align-items: center; }
        .typing-dot { width: 6px; height: 6px; background: var(--text-light); border-radius: 50%; animation: typing 1.4s infinite ease-in-out both; opacity: 0.6; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* Widget Styles */
        .list-view { display: flex; flex-direction: column; gap: 8px; margin: 8px 0; width: 100%; }
        .list-view-item { display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); transition: background 0.2s; }
        .list-view-item:hover { background: var(--bg-alt); }
        .list-view-icon-box { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: rgba(37, 99, 235, 0.1); border-radius: 6px; color: var(--primary); flex-shrink: 0; }
        .list-view-content { flex: 1; display: flex; flex-direction: column; gap: 2px; min-width: 0; }
        .list-view-title { font-weight: 600; font-size: 0.95rem; color: var(--text); }
        .list-view-subtitle { font-size: 0.8rem; color: var(--text-light); }
        .list-view-badge { padding: 2px 8px; border-radius: 999px; font-size: 0.75rem; background: var(--bg-alt); border: 1px solid var(--border); color: var(--text-light); white-space: nowrap; }
        .list-view-action { padding: 6px 12px; border: 1px solid var(--border); border-radius: 6px; background: transparent; color: var(--text); font-size: 0.85rem; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .list-view-action:hover { border-color: var(--primary); color: var(--primary); background: rgba(37, 99, 235, 0.05); }

        /* Card Widget Styles */
        .card-widget { border: 1px solid var(--border); border-radius: 12px; overflow: hidden; background: var(--bg); margin: 12px 0; box-shadow: var(--shadow); }
        .card-header { padding: 12px 16px; display: flex; align-items: center; gap: 12px; background: var(--bg-alt); border-bottom: 1px solid var(--border); }
        .card-title { font-weight: 600; font-size: 0.9rem; color: var(--text); }
        .card-badge { margin-left: auto; background: #e0f2fe; color: #0369a1; padding: 2px 8px; border-radius: 999px; font-size: 0.75rem; font-weight: 500; }
        /* :root[data-theme="dark"] .card-badge { background: #0c4a6e; color: #bae6fd; } */
        .card-body { padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        .card-row { display: flex; align-items: center; gap: 12px; padding: 8px; border-radius: 8px; transition: background 0.2s; }
        .card-row:hover { background: var(--bg-alt); }
        .card-icon { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: rgba(37, 99, 235, 0.1); border-radius: 6px; color: var(--primary); flex-shrink: 0; }
        .card-content { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; }
        .card-row-header { display: flex; align-items: center; justify-content: space-between; }
        .card-price { background: #f3f4f6; color: #374151; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-family: monospace; }
        /* :root[data-theme="dark"] .card-price { background: #374151; color: #e5e7eb; } */
        .card-features { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 4px; }
        .feature-tag { font-size: 0.7rem; padding: 1px 6px; border-radius: 4px; background: var(--bg-alt); border: 1px solid var(--border); color: var(--text-light); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body>
    
    <div id="chat-container">
        <div class="message assistant">
            <div class="avatar">ðŸ¤–</div>
            <div class="bubble">
                <p>Hello! I'm your Azure AI assistant. I can help you analyze model pricing, compare features, or answer questions about the Azure ecosystem.</p>
            </div>
        </div>
    </div>
    
    <div class="typing-indicator" id="typing-indicator">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
    </div>

    <div class="input-area">
        <div class="input-wrapper">
            <textarea id="user-input" rows="1" placeholder="Ask about Azure models..." autocomplete="off"></textarea>
            <button id="send-btn" title="Send Message">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
            </button>
        </div>
    </div>

    <script>
        // Theme handling
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('theme') === 'dark' || window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.setAttribute('data-theme', 'dark');
        }

        // Listen for theme changes from parent
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'theme') {
                if (event.data.theme === 'dark') {
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.removeAttribute('data-theme');
                }
            }
        });

        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const typingIndicator = document.getElementById('typing-indicator');

        let messages = [
            { role: "system", content: "You are a helpful AI assistant for Model Meters. You help users understand Azure AI pricing and capabilities. You have access to tools to search Microsoft documentation. When asked about available models, list them clearly. Use Markdown tables for data. If you need to display a list of items (like models), you can output a JSON block with type 'list-view' to render a rich widget. Example: ```json\n{\"type\": \"list-view\", \"items\": [{\"id\": \"1\", \"name\": \"Model\", \"provider\": \"OpenAI\", \"icon\": \"box\", \"typeLabel\": \"Chat\"}]}\n```" }
        ];

        // Auto-resize textarea
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            if(this.value === '') this.style.height = 'auto';
        });

        // Handle Enter key
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        sendBtn.addEventListener('click', sendMessage);

        function extractWidgetData(text) {
            // 1. Try existing regex with code blocks (most reliable)
            const codeBlockRegex = /([\s\S]*?)```(?:json)?\s*({[\s\S]*?"type":\s*"(?:list-view|model-card)"[\s\S]*?})\s*```([\s\S]*)/;
            const match = text.match(codeBlockRegex);
            if (match) return { textBefore: match[1], jsonStr: match[2], textAfter: match[3] };
            
            // 2. Try to find raw JSON
            const typeMatch = text.match(/"type":\s*"(list-view|model-card)"/);
            if (!typeMatch) return null;
            
            let startIndex = text.indexOf('{');
            while (startIndex !== -1) {
                let count = 1;
                let endIndex = -1;
                let inString = false;
                let escape = false;
                
                for (let i = startIndex + 1; i < text.length; i++) {
                    const char = text[i];
                    if (escape) { escape = false; continue; }
                    if (char === '\\') { escape = true; continue; }
                    if (char === '"') { inString = !inString; continue; }
                    if (!inString) {
                        if (char === '{') count++;
                        else if (char === '}') count--;
                        
                        if (count === 0) {
                            endIndex = i + 1;
                            break;
                        }
                    }
                }
                
                if (endIndex !== -1) {
                    const candidateJson = text.substring(startIndex, endIndex);
                    if (candidateJson.includes(typeMatch[0])) {
                        return {
                            textBefore: text.substring(0, startIndex),
                            jsonStr: candidateJson,
                            textAfter: text.substring(endIndex)
                        };
                    }
                }
                startIndex = text.indexOf('{', startIndex + 1);
            }
            return null;
        }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            // Add user message
            addMessage('user', text);
            messages.push({ role: "user", content: text });
            
            // Reset input
            userInput.value = '';
            userInput.style.height = 'auto';
            userInput.disabled = true;
            sendBtn.disabled = true;
            typingIndicator.classList.add('active');

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        messages: messages
                    })
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(errText || 'Failed to get response');
                }

                // Create placeholder for streaming response
                const messageDiv = addMessage('assistant', ''); 
                const bubble = messageDiv.querySelector('.bubble');
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let fullText = '';
                let displayedText = '';
                const tokenQueue = [];
                let isStreamDone = false;

                // Typewriter effect loop
                const processQueue = () => {
                    if (tokenQueue.length > 0) {
                        // Dynamic speed: faster if queue is long
                        const chunkSize = Math.max(2, Math.floor(tokenQueue.length / 40));
                        const chunk = tokenQueue.splice(0, chunkSize).join('');
                        displayedText += chunk;

                        // Render
                        const widgetData = extractWidgetData(displayedText);
                        
                        if (widgetData) {
                            try {
                                const { textBefore, jsonStr, textAfter } = widgetData;
                                const parsedWidget = JSON.parse(jsonStr);
                                bubble.innerHTML = marked.parse(textBefore) + renderWidget(parsedWidget) + marked.parse(textAfter);
                            } catch (e) {
                                bubble.innerHTML = marked.parse(displayedText);
                            }
                        } else {
                            bubble.innerHTML = marked.parse(displayedText);
                        }
                        
                        bubble.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }

                    if (!isStreamDone || tokenQueue.length > 0) {
                        requestAnimationFrame(processQueue);
                    }
                };
                requestAnimationFrame(processQueue);

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) {
                        isStreamDone = true;
                        break;
                    }
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); 
                    
                    for (const line of lines) {
                        if (!line.trim()) continue;
                        try {
                            const event = JSON.parse(line);
                            let delta = '';
                            if (event.delta) delta = event.delta;
                            else if (event.type === 'response.text.delta' && event.delta) delta = event.delta;
                            
                            if (delta) {
                                fullText += delta;
                                for (const char of delta) tokenQueue.push(char);
                            }
                        } catch (e) {
                            console.warn("Error parsing stream line", e);
                        }
                    }
                }
                
                messages.push({ role: "assistant", content: fullText });

            } catch (err) {
                addMessage('assistant', `**Error:** ${err.message}. Please try again.`);
                console.error(err);
            } finally {
                userInput.disabled = false;
                sendBtn.disabled = false;
                typingIndicator.classList.remove('active');
                userInput.focus();
            }
        }

        function renderWidget(data) {
            if (data.type === 'list-view') {
                // ... existing list-view code ...
                const items = data.items || [];
                const itemsHtml = items.map(item => `
                    <div class="list-view-item">
                        <div class="list-view-icon-box">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                            </svg>
                        </div>
                        <div class="list-view-content">
                            <div class="list-view-title">${item.name || 'Unknown'}</div>
                            <div class="list-view-subtitle">${item.provider || ''}</div>
                        </div>
                        ${item.typeLabel ? `<div class="list-view-badge">${item.typeLabel}</div>` : ''}
                        <button class="list-view-action" onclick="window.parent.postMessage({type:'model.select', id:'${item.id}'}, '*')">Use</button>
                    </div>
                `).join('');
                return `<div class="list-view">${itemsHtml}</div>`;
            } else if (data.type === 'model-card') {
                const models = data.models || [];
                const rowsHtml = models.map(item => `
                    <div class="card-row">
                        <div class="card-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>
                        </div>
                        <div class="card-content">
                            <div class="card-row-header">
                                <span style="font-weight:600; font-size:0.9rem;">${item.name}</span>
                                ${item.price ? `<span class="card-price">${item.price}</span>` : ''}
                            </div>
                            <div style="font-size:0.8rem; color:var(--text-light);">${item.provider}</div>
                            ${item.features && item.features.length ? `
                                <div class="card-features">
                                    ${item.features.map(f => `<span class="feature-tag">${f}</span>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                        <button class="list-view-action" onclick="window.parent.postMessage({type:'model.view', id:'${item.id}'}, '*')">Details</button>
                    </div>
                `).join('');

                return `
                    <div class="card-widget">
                        <div class="card-header">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                            <span class="card-title">${data.title || 'Models'}</span>
                            <span class="card-badge">Costs per model</span>
                        </div>
                        <div class="card-body">
                            ${rowsHtml}
                        </div>
                    </div>
                `;
            }
            return '';
        }

        function addMessage(role, text) {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            
            const avatar = role === 'user' ? 'ðŸ‘¤' : 'ðŸ¤–';
            
            // Parse markdown
            let content = text;
            if (role === 'assistant') {
                content = marked.parse(text);
            } else {
                // Escape HTML for user input to prevent XSS, but allow line breaks
                content = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, "<br>");
            }
            
            div.innerHTML = `
                <div class="avatar">${avatar}</div>
                <div class="bubble">${content}</div>
            `;
            
            chatContainer.appendChild(div);
            
            // Highlight code blocks
            div.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });

            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            return div;
        }
    </script>
</body>
</html>